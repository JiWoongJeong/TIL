## 7. SQL 응용

### 1. DB 기본

#### 1. 트랜잭션

- 트랜잭션

  - 특성 : **ACID**

    |           특성            |                             설명                             |                          주요 기법                           |
    | :-----------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
    |  원자성<br />(Atomicity)  | 분해 X 작업 최소단위<br />연산 전체 성공 or 실패 (All or Nothing)<br />하나라도 실패 -> 전체 취소 |              Commit / Rollback<br />회복성 보장              |
    | 일관성<br />(Consistency) |         트랜잭션 실행 성공 -> 항상 일관 DB 상태 보존         |                 무결성 제약조건, 동시성 제어                 |
    |  격리성<br />(Isolation)  | 트랜잭션 실행 중 생성 연산 중간 결과<br />-> 다른 트랜잭션이 접근 불가 | Read Uncommitted / Committed<br />Repeatable Read, Serializable |
    | 영속성<br />(Durability)  |      성공 완료 트랜잭션 결과<br />-> 영속적으로 DB 저장      |                          회복 기법                           |

  - 상태 변화 : **활부완실철**

    |                   상태                    |                  설명                   |
    | :---------------------------------------: | :-------------------------------------: |
    |          활동 상태<br />(Active)          |       초기 상태, 트랜잭션 실행 중       |
    | 부분 완료 상태<br />(Partially Committed) |          마지막 명령문 실행 후          |
    |        완료 상태<br />(Committed)         |                                         |
    |          실패 상태<br />(Failed)          |            정상 실행 진행 X             |
    |         철회 상태<br />(Aborted)          | 트랜잭션 취소, DB 트랜잭션 시작 전 환원 |

  - TCL (Transaction Control Language) 제어 : **커롤체**

    |   명령어   |      특성      |             설명             |
    | :--------: | :------------: | :--------------------------: |
    |   Commit   | 트랜잭션 확정  | 트랜잭션 -> 메모리 영구 저장 |
    |  Rollback  | 트랜잭션 취소  | 트랜잭션 내역 -> 저장 무효화 |
    | Checkpoint | 저장 시기 설정 |      Rollback 시점 지정      |

  - 병행 제어 (일관성 주요 기법)

    - 미보장 시 문제점 : **갱현모연**

      |               문제점                |                             설명                             |
      | :---------------------------------: | :----------------------------------------------------------: |
      |    갱신 손실<br />(Lost Update)     | 먼저 실행 트랜잭션 결과<br />-> 나중 실행 트랜잭션 덮어쓸 때 |
      |   현황 파악오류<br />(Dirty Read)   |    트랜잭션 중간 수행 결과<br />-> 다른 트랜잭션 참조 시     |
      |     모순성<br />(Inconsistency)     |             두 트랜잭션 동시 실행 -> DB 일관성 X             |
      | 연쇄 복귀<br />(Cascading Rollback) | 복수 트랜잭션 데이터 공유 시<br />-> 특정 트랜잭션 처리 취소<br />-> 처리 부분 취소 불가능 |

    - 종류 : **로 낙타다**

      |                             기법                             |                             설명                             |
      | :----------------------------------------------------------: | :----------------------------------------------------------: |
      |                     로킹 <br />(Locking)                     | 같은 자원 액세스 다중 트랜잭션 환경<br />-> DB 일관, 무결성 유지 -> 트랜잭션 순차 진행 보장 직렬화 기법 |
      |                         낙관적 검증                          | 어떤 검증 수행 X 먼저 트랜잭션 수행<br />-> 트랜잭션 종료 시 검증 수행 => DB 수행 |
      |         타임 스탬프 순서<br />(Time Stamp Ordering)          | 읽거나 갱신한 데이터에 트랜잭션 실행 전<br />-> 타임 스탬프 부야 -> 시간 따라 트랜잭션 수행 |
      | 다중버전 동시성 제어<br />(MVCC : Multi Version<br />Concurrency Control) | 트랜잭션 타임스탬프 ~ 접근 데이터 타임스탬프 비교<br />-> 질렬 가능성 보장 버전 선택 |

      - 로킹 : 단위 작아지면 DB 공유도, 로킹 오버헤드 증가, 로킹 단위 - 한번에 로킹할 수 있는 객체 크기

  - 회복 기법 (영속성 주요 기법)

    - 종류 : **회로체크**

      |                         기법                          |                   설명                   |
      | :---------------------------------------------------: | :--------------------------------------: |
      |                  로그 기반 회복 기법                  |      지연 갱신, 즉각 갱신 회복 기법      |
      |   체크 포인트 회복 기법<br />(Checkpoint Recovery)    | 장애 -> 검사점 이후 처리 트랜잭션만 복원 |
      | 그림자 페이징 회복 기법<br />(Shadow Paging Recovery) |       복제본 생성 -> 장애 시 복구        |

      - 지연 갱신 (Deferred Update) : 트랜잭션 완료 전까지 DB에 기록 X
      - 즉각 갱신 (Immediate Update) : 트랜잭션 수행 중 갱신 결과 바로 DB 반영

- DDL (Data Definition Language)

  - 대상 : **도스테뷰인**

    |  대상  |                             설명                             |
    | :----: | :----------------------------------------------------------: |
    | 도메인 | 하나 속성 -> 원자값 집합<br />속성 데이터 타입, 크기, 제약조건 정보 |
    | 스키마 |    DB 구조, 제약조건 정보 기본적 구조<br />외부/개념/내부    |
    | 테이블 |                       데이터 저장 공간                       |
    |   뷰   |            하나 이상 물리 테이블 유도 가상 테이블            |
    | 인덱스 |                             검색                             |

    - 외부 스키마 (External, 서브 스키마) : 사용자, 개발자 관점 -> 필요 DB 논리적 구조 / 사용자 뷰
    - 개념 스키마 (Conceptual) : DB 전체 논리적 구조, 전체적 뷰, 개체 간 관계, 제약조건, 접근 권한, 무결성, 보안
    - 내부 스키마 (Internal) : 물리적 저장장치 관점 DB 구조, 실제 저장 레코드 형식 정의, 저장 데이터 항목 표현 방법, 내부 레코드 물리적 순서

  - 인덱스

    - 종류 : **순해비함 단결클**

      |               유형                |                             설명                             |
      | :-------------------------------: | :----------------------------------------------------------: |
      |    순서 인덱스<br />(Ordered)     | 정렬된 순서로 생성<br />B-Tree 알고리즘 -> 오름/내림차순 지정 가능 |
      |            해시 인덱스            | 해시 함수 -> 직접 데이터에 키 값으로 접근<br />데이터 접근 비용 균일, 튜플(row) 양 무관 |
      |           비트맵 인덱스           |       컬럼에 적은 개수 값 저장<br />수정 변경 적을 때        |
      | 함수기반 인덱스<br />(Functional) |                          수식, 함수                          |
      |    단일 인덱스<br />(Singled)     |             하나 컬럼, 주 사용 컬럼이 하나일 때              |
      | 결합 인덱스<br />(Concaternated)  |        두 개 이상 컬럼, WHERE 조건 사용 빈도 높을 때         |
      |         클러스터드 인덱스         | 기본 키 (PK) 기준 레코드 묶어서 저장<br />저장 데이터 물리적 순서 따라 인덱스 생성<br />특정 범위 검색 시 |

  - 명령어 : **크알드트**

    |  명령어  |         설명          |
    | :------: | :-------------------: |
    |  CREATE  |   DB 오브젝트 생성    |
    |  ALTER   |   DB 오브젝트 변경    |
    |   DROP   |   DB 오브젝트 삭제    |
    | TRUNCATE | DB 오브젝트 내용 삭제 |

- DML (Data Manipulation Language)

  - 명령어 : **세인업데**

    |  유형  | 동작 |          설명           |
    | :----: | :--: | :---------------------: |
    | SELECT | 조회 | 컬럼에 저장 데이터 조회 |
    | INSERT | 삽입 |   컬럼에 데이터 추가    |
    | UPDATE | 갱신 |  컬럼 저장 데이터 수정  |
    | DELETE | 삭제 |  컬럼 저장 데이터 삭제  |
    
  - SELECT 명령어 : **셀프 웨 구해오**

    |   구분   |                             설명                             |
    | :------: | :----------------------------------------------------------: |
    |  SELECT  | 속성명, 계산식<br />별칭 -> AS<br />2개 이상 테이블 대상 : '테이블명.속석명'<br />술어 : ALL 기본 |
    |   FROM   |                  검색 데이터 포함 테이블명                   |
    |  WHERE   |                          검색 조건                           |
    | GROUP BY |                       속성값 그룹 분류                       |
    |  HAVING  |               GROUP BY 분류 후 그룹 조건 지정                |
    | ORDER BY |                       정렬 : ASC, DESC                       |

    - SELECT
      - ALL : 모든 튜플 검색
      - DISTINCT : 중복 속성 조회 -> 한 개만 검색

- DCL (Data Control Language)

  - 명령어 : **그온투**, **리온프**

    |  유형  |      동작      |              설명               |               사례                |
    | :----: | :------------: | :-----------------------------: | :-------------------------------: |
    | GRANT  | 사용 권한 부여 | 관리자 -> 사용자 : DB 권한 부여 |  GRANT 권한 ON 테이블 TO 사용자   |
    | REVOKE | 사용 권한 취소 |  관리자 -> 사용자 : 권한 회수   | REVOKE 권한 ON 테이블 FROM 사용자 |

### 2. 응용 SQL 작성하기

#### 1. 집계성 SQL 작성

- 윈도 함수

  - 분류 : **순행비**

    |       분류        |                설명                |
    | :---------------: | :--------------------------------: |
    |     순위 함수     |    RANK, DENSE_RANK, ROW_NUMBER    |
    |   행 순서 함수    | FIRST_VALUE, LAST_VALUE, LAG, LEAD |
    | 그룹 내 비율 함수 |   RATIO_TO_REPORT, PERCENT_RANK    |

### 3. 절차형 SQL 활용하기

#### 1. 절차형 SQL

#### 2. 프로시저

- 개념 : 일련 쿼리 하나의 함수처럼 실행 쿼리 집합
- 구성 : **디비컨 SET**

|             요소             |                             설명                             |
| :--------------------------: | :----------------------------------------------------------: |
|    선언부<br />(DECLARE)     |              명칭, 변수, 인수, 데이터 타입 정의              |
| 시작/종료부<br />(BEGIN/END) | 시작, 종료 -> 쌍<br />다수 실행 제어 기본적 단위, 논리적 프로세스 |
|    제어부<br />(CONTROL)     |                 순차 처리<br />조건, 반복문                  |
|             SQL              |                   DML<br />DDL - TRUNCATE                    |
|   예외부<br />(EXCEPTION)    |   BEGIN ~ END SQL 실행 중 예외 발생 시 예외 처리 방법 정의   |
|  실행부<br />(TRANSACTION)   |        DML 수행 내역 DBMS 적용, 취소 여부 결정 처리부        |

- 문법

  | 구성  |                설명                |
  | :---: | :--------------------------------: |
  |  IN   |    OS -> 프로시저 값 전달 모드     |
  |  OUT  | 프로시저 -> OS 처리 결과 전달 모드 |
  | INOUT |              IN + OUT              |

#### 3. 사용자 정의함수

- 개념 : 일련 SQL 처리 수행, 수행 결과 단일 값 반환 가능 절차형 SQL

- 구성 : **디비컨 SER**

  |         요소         |    설명     |
  | :------------------: | :---------: |
  | 반환부<br />(RETURN) | 함숫값 반환 |

- 문법

  | 구성  |                   설명                    |
  | :---: | :---------------------------------------: |
  |  IN   |    OS -> 사용자 정의함수 값 전달 모드     |
  |  OUT  | 사용자 정의함수 -> OS 처리 결과 전달 모드 |
  | INOUT |                 IN + OUT                  |

#### 4. 트리거

- DB 시스템에서 삽입, 갱신, 삭제 이벤트 발생 시 관련 작업 자동 수행 절차형 SQL

- 구성 : **디이비컨 SE**

  |         요소          |           설명           |
  | :-------------------: | :----------------------: |
  | 이벤트부<br />(EVENT) | 실행 타이밍, 이벤트 명시 |

- 문법

  |  구성  |                  설명                  |
  | :----: | :------------------------------------: |
  | BEFORE |  삽입, 갱신, 삭제 수행 전 트리거 실행  |
  | AFTER  | 삽입, 갱신, 삭제 수행 이후 트리거 실행 |

### 4. 데이터 조작 프로시저 최적화

#### 1. 데이터 조작 프로시저 성능 개선

- 옵티마이저 통계 확인

  - 개념

    - SQL 가장 빠르고 효율적 수행 최적 (최저비용) 처리경로 생성 -> 명시적 힌트를 통해 실행계획 변경

  - 유형

    |   비교    |                  규칙기반 옵티마이저 (RBO)                  |                  비용기반 옵티마이저 (CBO)                   |
    | :-------: | :---------------------------------------------------------: | :----------------------------------------------------------: |
    |   개념    | 통계 정보 X -> 사전 등록된 규칙<br />=> 질의 실행 계획 선택 | 통계 정보 -> 모든 접근 경로 고려<br />=> 질의 실행 계획 선택 |
    |   핵심    |                    규칙 기반 (우선 순위)                    |                    비용 기반 (수행 시간)                     |
    | 평가 기준 |                 인덱스 구조, 연산자, 조건절                 | 레코드/블록 개수, 평균 행 길이<br />컬럼 값 수/분포, 인덱스 높이, 클러스터링 팩터 |
    |   장점    |                    원하는 처리경로 유도                     |             이해도 낮아도 성능 보장 (기본 설정)              |

    